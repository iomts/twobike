<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>微信支付之统一下单--JAVA版.md</title><link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css'><style type='text/css'>html, body {overflow-x: initial !important;}html { font-size: 14px; }
body { margin: 0px; padding: 0px; height: auto; bottom: 0px; top: 0px; left: 0px; right: 0px; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 1rem; line-height: 1.42857; color: rgb(51, 51, 51); overflow-x: hidden; background-color: rgb(255, 255, 255); }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: rgb(181, 214, 252); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; word-wrap: break-word; position: relative; padding-bottom: 70px; white-space: pre-wrap; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
@media screen and (max-width: 500px) { 
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
.typora-export #write { margin: 0px auto; }
#write > p:first-child, #write > ul:first-child, #write > ol:first-child, #write > pre:first-child, #write > blockquote:first-child, #write > div:first-child, #write > table:first-child { margin-top: 30px; }
img { max-width: 100%; }
input, button, select, textarea { color: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; font-size: inherit; line-height: inherit; font-family: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
::before, ::after, * { box-sizing: border-box; }
#write p, #write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write div, #write pre { width: inherit; }
#write p, #write h1, #write h2, #write h3, #write h4, #write h5, #write h6 { position: relative; }
h1 { font-size: 2rem; }
p { -webkit-margin-before: 1rem; -webkit-margin-after: 1rem; -webkit-margin-start: 0px; -webkit-margin-end: 0px; }
.mathjax-block { margin-top: 0px; margin-bottom: 0px; -webkit-margin-before: 0rem; -webkit-margin-after: 0rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: bold; font-style: italic; }
a { cursor: pointer; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; margin: 4px 0px 0px; }
tr { page-break-inside: avoid; page-break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; page-break-inside: auto; text-align: left; }
table.md-table td { min-width: 80px; }
.CodeMirror-gutters { border-right-width: 0px; background-color: inherit; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
pre { white-space: pre-wrap; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences, pre.md-fences { font-size: 0.9rem; display: block; page-break-inside: avoid; text-align: left; overflow: visible; white-space: pre; position: relative !important; background: inherit; }
.md-fences .CodeMirror.CodeMirror-wrap { top: -1.6em; margin-bottom: -1.6em; }
.md-fences.mock-cm { white-space: pre-wrap; }
.show-fences-line-number pre.md-fences { padding-left: 0px; }
.show-fences-line-number pre.md-fences.mock-cm { padding-left: 40px; }
.footnotes { color: rgb(136, 136, 136); font-size: 0.9rem; padding-top: 1em; padding-bottom: 1em; }
.footnotes + .footnotes { margin-top: -1em; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; text-decoration: none; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 1rem; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: normal; text-align: left; box-sizing: content-box; direction: ltr; background: transparent; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li p, li .mathjax-block { margin: 0.5rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; }
@media print { 
  html, body { height: 100%; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  h1, h2, h3, h4, h5, h6 { page-break-after: avoid; orphans: 2; }
  p { orphans: 4; }
  html.blink-to-pdf { font-size: 13px; }
  .typora-export #write { padding-left: 1cm; padding-right: 1cm; }
  .typora-export #write::after { height: 0px; }
  @page { margin: 20mm 0mm; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
#write pre.md-meta-block { font-size: 0.8rem; min-height: 2.86rem; white-space: pre-wrap; display: block; background: rgb(204, 204, 204); }
p > .md-image:only-child { display: inline-block; width: 100%; text-align: center; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.mathjax-block { white-space: pre; overflow: hidden; width: 100%; }
p + .mathjax-block { margin-top: -1.143rem; }
.mathjax-block:not(:empty)::after { display: none; }
[contenteditable="true"]:active, [contenteditable="true"]:focus { outline: none; box-shadow: none; }
.task-list { list-style-type: none; }
.task-list-item { position: relative; padding-left: 1em; }
.task-list-item input { position: absolute; top: 0px; left: 0px; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc::after, .md-toc-content::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: bold; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) { 
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { color: inherit; font-size: inherit; font-style: inherit; font-weight: inherit; text-decoration: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
.md-tag { opacity: 0.5; }
code { text-align: left; }
h1 .md-tag, h2 .md-tag, h3 .md-tag, h4 .md-tag, h5 .md-tag, h6 .md-tag { font-weight: initial; opacity: 0.35; }
a.md-header-anchor.md-print-anchor { border: none !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: none !important; text-decoration: initial !important; text-shadow: initial !important; background: transparent !important; }
.md-inline-math .MathJax_SVG .noError { display: none !important; }
.mathjax-block .MathJax_SVG_Display { text-align: center; margin: 1em 0em; position: relative; text-indent: 0px; max-width: none; max-height: none; min-width: 0px; min-height: 0px; width: 100%; display: block !important; }
.MathJax_SVG_Display, .md-inline-math .MathJax_SVG_Display { width: auto; margin: inherit; display: inline-block !important; }
.MathJax_SVG .MJX-monospace { font-family: monospace; }
.MathJax_SVG .MJX-sans-serif { font-family: sans-serif; }
.MathJax_SVG { display: inline; font-style: normal; font-weight: normal; line-height: normal; zoom: 90%; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; }
.MathJax_SVG * { transition: none; }


@font-face { font-family: 'Open Sans'; font-style: normal; font-weight: normal; src: local("Open Sans Regular"), url("file:///C:/Users/helijun/AppData/Roaming/Typora/themes/github/400.woff") format("woff"); }
@font-face { font-family: 'Open Sans'; font-style: italic; font-weight: normal; src: local("Open Sans Italic"), url("file:///C:/Users/helijun/AppData/Roaming/Typora/themes/github/400i.woff") format("woff"); }
@font-face { font-family: 'Open Sans'; font-style: normal; font-weight: bold; src: local("Open Sans Bold"), url("file:///C:/Users/helijun/AppData/Roaming/Typora/themes/github/700.woff") format("woff"); }
@font-face { font-family: 'Open Sans'; font-style: italic; font-weight: bold; src: local("Open Sans Bold Italic"), url("file:///C:/Users/helijun/AppData/Roaming/Typora/themes/github/700i.woff") format("woff"); }
html { font-size: 16px; }
body { font-family: 'Open Sans', 'Clear Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif; color: rgb(51, 51, 51); line-height: 1.6; }
#write { max-width: 800px; margin: 0px auto; padding: 20px 30px 40px; }
#write::after { height: 80px; }
#write > ul:first-child, #write > ol:first-child { margin-top: 30px; }
body > :first-child { margin-top: 0px !important; }
body > :last-child { margin-bottom: 0px !important; }
a { color: rgb(65, 131, 196); }
h1, h2, h3, h4, h5, h6 { position: relative; margin-top: 1rem; margin-bottom: 1rem; font-weight: bold; line-height: 1.4; cursor: text; }
h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor { text-decoration: none; }
h1 tt, h1 code { font-size: inherit; }
h2 tt, h2 code { font-size: inherit; }
h3 tt, h3 code { font-size: inherit; }
h4 tt, h4 code { font-size: inherit; }
h5 tt, h5 code { font-size: inherit; }
h6 tt, h6 code { font-size: inherit; }
h1 { padding-bottom: 0.3em; font-size: 2.25em; line-height: 1.2; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(238, 238, 238); }
h2 { padding-bottom: 0.3em; font-size: 1.75em; line-height: 1.225; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(238, 238, 238); }
h3 { font-size: 1.5em; line-height: 1.43; }
h4 { font-size: 1.25em; }
h5 { font-size: 1em; }
h6 { font-size: 1em; color: rgb(119, 119, 119); }
p, blockquote, ul, ol, dl, table { margin: 0.8em 0px; }
li > ol, li > ul { margin: 0px; }
hr { height: 4px; padding: 0px; margin: 16px 0px; border-width: 0px 0px 1px; border-style: none none solid; overflow: hidden; box-sizing: content-box; border-bottom-color: rgb(221, 221, 221); background-color: rgb(231, 231, 231); }
body > h2:first-child { margin-top: 0px; padding-top: 0px; }
body > h1:first-child { margin-top: 0px; padding-top: 0px; }
body > h1:first-child + h2 { margin-top: 0px; padding-top: 0px; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child { margin-top: 0px; padding-top: 0px; }
a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 { margin-top: 0px; padding-top: 0px; }
h1 p, h2 p, h3 p, h4 p, h5 p, h6 p { margin-top: 0px; }
li p.first { display: inline-block; }
ul, ol { padding-left: 30px; }
ul:first-child, ol:first-child { margin-top: 0px; }
ul:last-child, ol:last-child { margin-bottom: 0px; }
blockquote { border-left-width: 4px; border-left-style: solid; border-left-color: rgb(221, 221, 221); padding: 0px 15px; color: rgb(119, 119, 119); }
blockquote blockquote { padding-right: 0px; }
table { padding: 0px; }
table tr { border-top-width: 1px; border-top-style: solid; border-top-color: rgb(204, 204, 204); margin: 0px; padding: 0px; background-color: white; }
table tr:nth-child(2n) { background-color: rgb(248, 248, 248); }
table tr th { font-weight: bold; border: 1px solid rgb(204, 204, 204); text-align: left; margin: 0px; padding: 6px 13px; }
table tr td { border: 1px solid rgb(204, 204, 204); text-align: left; margin: 0px; padding: 6px 13px; }
table tr th:first-child, table tr td:first-child { margin-top: 0px; }
table tr th:last-child, table tr td:last-child { margin-bottom: 0px; }
.CodeMirror-gutters { border-right-width: 1px; border-right-style: solid; border-right-color: rgb(221, 221, 221); }
pre.md-fences, .md-fences, code, tt { border: 1px solid rgb(221, 221, 221); border-radius: 3px; font-family: Consolas, 'Liberation Mono', Courier, monospace; padding: 2px 4px 0px; font-size: 0.9em; background-color: rgb(248, 248, 248); }
pre.md-fences, .md-fences { margin-bottom: 15px; margin-top: 15px; padding: 8px 1em 6px; }
.task-list { padding-left: 0px; }
.task-list-item { padding-left: 32px; }
.task-list-item input { top: 3px; left: 8px; }
@media screen and (min-width: 914px) { 
}
@media print { 
  html { font-size: 13px; }
  table, pre { page-break-inside: avoid; }
  pre { word-wrap: break-word; }
}
.md-fences { background-color: rgb(248, 248, 248); }
#write pre.md-meta-block { padding: 1rem; font-size: 85%; line-height: 1.45; border: 0px; border-radius: 3px; color: rgb(119, 119, 119); margin-top: 0px !important; background-color: rgb(247, 247, 247); }
.mathjax-block > .code-tooltip { bottom: 0.375rem; }
#write > h3.md-focus::before { left: -1.5625rem; top: 0.375rem; }
#write > h4.md-focus::before { left: -1.5625rem; top: 0.285714rem; }
#write > h5.md-focus::before { left: -1.5625rem; top: 0.285714rem; }
#write > h6.md-focus::before { left: -1.5625rem; top: 0.285714rem; }
.md-image > .md-meta { border: 1px solid rgb(221, 221, 221); border-radius: 3px; font-family: Consolas, 'Liberation Mono', Courier, monospace; padding: 2px 4px 0px; font-size: 0.9em; color: inherit; background-color: rgb(248, 248, 248); }
.md-tag { color: inherit; }
.md-toc { margin-top: 20px; padding-bottom: 20px; }
#typora-quick-open { border: 1px solid rgb(221, 221, 221); background-color: rgb(248, 248, 248); }
#typora-quick-open-item { border-color: rgb(254, 254, 254) rgb(229, 229, 229) rgb(229, 229, 229) rgb(238, 238, 238); border-style: solid; border-width: 1px; background-color: rgb(250, 250, 250); }
.on-focus-mode blockquote { border-left-color: rgba(85, 85, 85, 0.117647); }






</style>
</head>
<body class='typora-export ' >
<div  id='write'  class = 'is-node'><h1><a name='header-c95' class='md-header-anchor '></a>微信支付之统一下单--JAVA版</h1><blockquote><p>都说微信支付有些坑，都抱怨微信支付的文档太烂，一会APPId，一会商户id，还有appsecret，支付API秘钥让你傻傻分不清楚，还有这里大写那里小写，几种标准，让你眼花缭乱。没错，这就是很多技术团队都存在的问题，没有统一的标准！且团队越大越严重，即使是在微信这样的顶尖团队。然而这些在一番痛苦折腾之后，最后都会不值一提。<strong>这里只详细讲JSAPI方式的公众号支付</strong></p></blockquote><h2><a name='header-c101' class='md-header-anchor '></a>简要思路图</h2><p><img src='http://upload-images.jianshu.io/upload_images/2166524-9f1b66f15685ae94.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240' alt='' /></p><h2><a name='header-c104' class='md-header-anchor '></a>配置支付授权目录</h2><p>有点类似授权回调安全域名的韵味，需要将支付的页面路径添加到授权目录里面，否则再页面调起支付时会报没有添加支付目录的错误
<img src='http://upload-images.jianshu.io/upload_images/2166524-13686702ef80d6f0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240' alt='' /></p><p>配置地址： 微信公众平台-微信支付-开发配置</p><h2><a name='header-c110' class='md-header-anchor '></a>获取openid</h2><p><a href='http://www.cnblogs.com/liliangel/p/6045201.html'>参考之前的微信授权文章</a></p><h2><a name='header-c113' class='md-header-anchor '></a>统一下单</h2><p>通常情况下是自身系统生成订单后进入支付页面，用户点击支付触发一个请求，将订单id、openid传给后台微信统一下单接口，后台根据订单id在自身系统查询一遍，获得价格、描述详情等信息</p><h4><a name='header-c116' class='md-header-anchor '></a>一次签名，发送xml报文给微信服务器</h4><pre class='md-fences mock-cm' style='display:block;position:relative'>String nonceStr = &quot;5K8264ILTKCH16CQ2502SI8ZNMTM67VS&quot;;//暂时不变
    
// 加密，这里只列举必填字段
Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();
map.put(&quot;body&quot;, body);//商品描述
map.put(&quot;mch_id&quot;, MCHID);//商户平台id
map.put(&quot;appid&quot;, WX_APPID);//公众号id
map.put(&quot;nonce_str&quot;, nonceStr);//随机字符串
map.put(&quot;notify_url&quot;, WX_PAY_CALLBACK);//异步回调api
map.put(&quot;spbill_create_ip&quot;, ip);//支付ip
map.put(&quot;out_trade_no&quot;, orderSn);//商品订单号
map.put(&quot;total_fee&quot;, (int) relAmount + &quot;&quot;);//真实金额
map.put(&quot;trade_type&quot;, &quot;JSAPI&quot;);//JSAPI、h5调用
map.put(&quot;openid&quot;, openid);//支付用户openid

String sign = WxPaySignatureUtils.signature(map, WX_PAY_KEY);

String xml = &quot;&lt;xml&gt;&quot; +
    	        &quot;&lt;appid&gt;&quot;+ WX_APPID +&quot;&lt;/appid&gt;&quot;+
    	        &quot;&lt;body&gt;&quot;+ body +&quot;&lt;/body&gt;&quot;+
    	        &quot;&lt;mch_id&gt;&quot;+ MCHID +&quot;&lt;/mch_id&gt;&quot;+
    	        &quot;&lt;nonce_str&gt;&quot;+ nonceStr +&quot;&lt;/nonce_str&gt;&quot;+
    	        &quot;&lt;notify_url&gt;&quot;+ WX_PAY_CALLBACK +&quot;&lt;/notify_url&gt;&quot;+
    	        &quot;&lt;openid&gt;&quot;+ openid +&quot;&lt;/openid&gt;&quot;+
    	        &quot;&lt;out_trade_no&gt;&quot;+ orderSn +&quot;&lt;/out_trade_no&gt;&quot;+
    	        &quot;&lt;spbill_create_ip&gt;&quot;+ ip +&quot;&lt;/spbill_create_ip&gt;&quot;+
    	        &quot;&lt;total_fee&gt;&quot;+ (int) relAmount + &quot;&quot; +&quot;&lt;/total_fee&gt;&quot;+
    	        &quot;&lt;trade_type&gt;JSAPI&lt;/trade_type&gt;&quot;+
    	        &quot;&lt;sign&gt;&quot;+ sign +&quot;&lt;/sign&gt;&quot;+
    	     &quot;&lt;/xml&gt;&quot;;

LOGGER.info(&quot;发送给微信的报文：&quot; + xml);
LOGGER.info(&quot;加密后的的签名字符串：&quot; + sign);

// 请求
String response = &quot;&quot;;
try {
    response = apiService.doPostString(WX_UNIFIEDORDER, xml);
} catch (Exception e) {
    //TODO
    return null;
}
LOGGER.info(&quot;请求/pay/unifiedorder下单接口后返回数据：&quot; + response);
//处理请求结果
XStream s = new XStream(new DomDriver());
s.alias(&quot;xml&quot;, WechatOrder.class);
WechatOrder order = (WechatOrder) s.fromXML(response);

if (&quot;SUCCESS&quot;.equals(order.getReturn_code()) &amp;&amp; &quot;SUCCESS&quot;.equals(order.getResult_code())) {
	LOGGER.info(&quot;微信支付统一下单请求成功，获得的Prepay_id是：&quot; + order.getPrepay_id());
} else {
	LOGGER.error(&quot;微信支付统一下单请求错误：&quot; + order.getReturn_msg() + order.getErr_code());
	//TODO
    return null;
}
</pre><p>注：</p><ol><li>WX_UNIFIEDORDER变量的地址是： <a href='https://api.mch.weixin.qq.com/pay/unifiedorder' target='_blank' >https://api.mch.weixin.qq.com/pay/unifiedorder</a></li><li>relAmount 是实际支付的金额，实际项目中应该是根据订单号在自身系统查询后获得</li><li>body 是最终显示在支付凭证里面的【商品详情】</li><li>orderSn 是最终显示在支付凭证-交易记录 里面的【商户单号】，也就是自身系统的订单号</li></ol><p>这个时候如果你看到下面的日志，恭喜你伟大的第一步已经完成了，可以小憩喝杯咖啡再来哈哈</p><pre class='md-fences mock-cm' style='display:block;position:relative'>11:46:25.170 INFO  com.cramix.portal.service.WechatService 451 createOrder - 请求/pay/unifiedorder下单接口后返回数据：&lt;xml&gt;&lt;return_code&gt;&lt;![CDATA[SUCCESS]]&gt;&lt;/return_code&gt;&lt;return_msg&gt;&lt;![CDATA[OK]]&gt;&lt;/return_msg&gt;&lt;appid&gt;&lt;![CDATA[wx8daca08d2f87216f]]&gt;&lt;/appid&gt;&lt;mch_id&gt;&lt;![CDATA[1482800922]]&gt;&lt;/mch_id&gt;&lt;nonce_str&gt;&lt;![CDATA[mjIbwmjLNFcD5tAF]]&gt;&lt;/nonce_str&gt;&lt;sign&gt;&lt;![CDATA[65EFB7B0BACBA01163765EB28B4E3F31]]&gt;&lt;/sign&gt;&lt;result_code&gt;&lt;![CDATA[SUCCESS]]&gt;&lt;/result_code&gt;&lt;prepay_id&gt;&lt;![CDATA[wx201706291146256b14b6eb620242392023]]&gt;&lt;/prepay_id&gt;&lt;trade_type&gt;&lt;![CDATA[JSAPI]]&gt;&lt;/trade_type&gt;&lt;/xml&gt;
11:46:25.179 INFO  com.cramix.portal.service.WechatService 459 createOrder - 微信支付统一下单请求成功，获得的Prepay_id是：wx201706291146256b14b6eb620242392023
</pre><p>当然，更多的时候不会有这么顺利，大多数人都会遇到<strong>签名错误</strong>的状态返回，微信确实是很喜欢用签名，签名错误这个四个字估计把所有的微信开发者都折磨了一遍，没有经历过签名错误的程序员不是真正的微信开发者。</p><p>然而，签名错误该怎么解决呢？通常情况下注意有三：</p><ol><li>发送给微信的xml报文格式、字段有误。body字段如有中文一定要在请求里面加上这句：</li></ol><pre class='md-fences mock-cm' style='display:block;position:relative'>HttpPost post = new HttpPost(uri);
post.setEntity(new StringEntity(str,&quot;utf-8&quot;));</pre><ol><li>加密算法是否有误，参考<a href='https://github.com/helijun/documents/blob/master/util/WxPaySignatureUtils.java'>WxPaySignatureUtils</a></li><li>确认商户平台API秘钥（仔细阅读微信支付申请成功后发过来的邮件，点击【下载API证书、设置API密钥】）</li></ol><h4><a name='header-c152' class='md-header-anchor '></a>二次签名</h4><p>当你喝完那杯“甜”的咖啡之后，就要撸接下来的代码了。将前端需要用的字段进行加密校验，并返回</p><p>核心代码如下：</p><pre class='md-fences mock-cm' style='display:block;position:relative'>HashMap&lt;String, String&gt; back = new HashMap&lt;String, String&gt;();
String time = Long.toString(System.currentTimeMillis());
back.put(&quot;appId&quot;, WX_APPID);
back.put(&quot;timeStamp&quot;, time);
back.put(&quot;nonceStr&quot;, nonceStr);
back.put(&quot;package&quot;, &quot;prepay_id=&quot; + order.getPrepay_id());
back.put(&quot;signType&quot;, &quot;MD5&quot;);
String sign2 = WxPaySignatureUtils.signature(back, WX_PAY_KEY);
LOGGER.info(&quot;二次签名后返回给前端的签名证书字符串是：&quot; + sign2);

JSONObject jsonObject = new JSONObject();
jsonObject.put(&quot;appId&quot;, WX_APPID);
jsonObject.put(&quot;timeStamp&quot;, time);
jsonObject.put(&quot;nonceStr&quot;, nonceStr);
jsonObject.put(&quot;package&quot;, &quot;prepay_id=&quot; + order.getPrepay_id());
jsonObject.put(&quot;signType&quot;, &quot;MD5&quot;);
jsonObject.put(&quot;paySign&quot;, sign2);

LOGGER.info(&quot;二次签名后返回给前端的数据是：&quot; + jsonObject.toJSONString());
</pre><p>到此为止，微信支付统一下单环节简单的后台代码已经码好了，只欠前端唤起支付了！</p><h2><a name='header-c159' class='md-header-anchor '></a>前端调起支付</h2><p>这里有个巨坑，千万不要踩，微信公众平台技术文档-微信JSSDK里面的微信支付跟这里没有任何关系！<strong>你只要看商户平台的文档！</strong>，也就是通过WeixinJSBridge对象去调用，当然只在微信app里有用！</p><pre class='md-fences mock-cm' style='display:block;position:relative'>//统一下单
unifiedorder: function(){
    var self = this;
    var userInfo = localStorage.getItem(&#39;ssqf_h5_wxUserInfo&#39;);

    CRAMIX.POST({
        baseUrl: URL.BASE + &#39;/api/wechat/pay/h5&#39;,
        data: {
            &#39;openid&#39;: JSON.parse(userInfo).openid,
            &#39;body&#39;:&#39;书身祈福支付&#39;,
            &#39;orderSn&#39;: $(&#39;#orderSn&#39;).val() || 20 ,
            &#39;amount&#39;: $(&#39;#money&#39;).val() || &#39;0.01&#39;
        },
        success: function(data){
            self.options.unifiedorderData = data;
        }
    })
},

//支付
pay: function(){
    var self = this;

    var appId = self.options.unifiedorderData.appId;
    var timeStamp = self.options.unifiedorderData.timeStamp;
    var nonceStr = self.options.unifiedorderData.nonceStr;
    var package1 = self.options.unifiedorderData.package;
    var paySign = self.options.unifiedorderData.paySign;

    WeixinJSBridge.invoke(
        &#39;getBrandWCPayRequest&#39;, {
            &quot;appId&quot;:appId,     //公众号名称，由商户传入
            &quot;timeStamp&quot;:timeStamp,         //时间戳，自1970年以来的秒数
            &quot;nonceStr&quot;:nonceStr, //随机串
            &quot;package&quot;:package1,
            &quot;signType&quot;:&quot;MD5&quot;,         //微信签名方式：
            &quot;paySign&quot;:paySign //微信签名
        },
        function(res){
            WeixinJSBridge.log(res.err_msg);
            if(res.err_msg == &quot;get_brand_wcpay_request:ok&quot;){
                window.location.href = &#39;/weixin/pay/pay-success.html&#39;;//去支付成功页面
            }else if(res.err_msg == &quot;get_brand_wcpay_request:cancel&quot;){
                $.toast(&quot;用户取消&quot;, &quot;text&quot;);
            }else{
                $.toast(&quot;支付失败&quot;, &quot;forbidden&quot;, function() {
                    window.location.reload();//刷新页面
                });
            }
        }
    );
},</pre><p>授权获取openid这里就不多说了，amount为支付金额，我这里是为了方便测试改为了金额前端传输，实际肯定不是哈！当然金额有变之后需要重新走一遍统一下单的流程。</p><h2><a name='header-c167' class='md-header-anchor '></a>感悟</h2><p>其实我们认为的所有坑大部分原因都是源自不细心，尽管文档等各种会让我们多走一些弯路，但是不能带着情绪去开发，遇到问题首先想自身不足，静下心来，写程序本身就需要有足够的耐心和十分的细心。去年做微信分享，也是有个签名，足足让我困了三天才搞定，有时候真的都怀疑人生了，但是最后都解决了，解决的那一瞬间，真的能感动自己！这回做微信支付，同样还是签名问题，也前前后后搞了差不多一天，当然这其中有很大部分原因是吸取了去年的经验，也就是上面所说。</p><h2><a name='header-c170' class='md-header-anchor '></a>参考资源</h2><p><a href='https://pay.weixin.qq.com/wiki/tools/signverify/'>微信公众平台支付接口调试工具</a></p><p></p><p></p><p><link rel="stylesheet" href="../../../static/github.css">
<script src="../../../static/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script></p></div>
</body>
</html>